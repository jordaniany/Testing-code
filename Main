# iZad_Integrated_v2.20 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (Ø°ÙƒÙŠØ© ÙˆÙ…ØªÙƒØ§Ù…Ù„Ø©)
from flask import Flask, render_template_string, request, redirect, url_for
import sqlite3
from datetime import datetime

app = Flask(__name__)

def init_db():
    conn = sqlite3.connect('izad_kitchen.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS kitchen_items (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        category TEXT,
        name TEXT NOT NULL,
        current_stock REAL,
        unit TEXT,
        purchase_source TEXT,
        expiry_date DATE
    )''')
    conn.commit()
    conn.close()

# --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© (Backend APIs) ---

@app.route('/update_qty/<int:item_id>/<float:delta>')
def update_qty(item_id, delta):
    conn = sqlite3.connect('izad_kitchen.db')
    conn.execute('UPDATE kitchen_items SET current_stock = current_stock + ? WHERE id = ?', (delta, item_id))
    conn.commit()
    conn.close()
    return redirect(url_for('kitchen'))

@app.route('/delete_item/<int:item_id>')
def delete_item(item_id):
    conn = sqlite3.connect('izad_kitchen.db')
    conn.execute('DELETE FROM kitchen_items WHERE id = ?', (item_id,))
    conn.commit()
    conn.close()
    return redirect(url_for('kitchen'))

@app.route('/add_item', methods=['POST'])
def add_item():
    conn = sqlite3.connect('izad_kitchen.db')
    conn.execute('''INSERT INTO kitchen_items 
        (category, name, current_stock, unit, purchase_source, expiry_date) 
        VALUES (?, ?, ?, ?, ?, ?)''', 
        (request.form.get('category'), request.form.get('name'), 
         request.form.get('current_stock'), request.form.get('unit'), 
         request.form.get('purchase_source'), request.form.get('expiry_date')))
    conn.commit()
    conn.close()
    return redirect(url_for('kitchen'))

# --- Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---

@app.route('/')
def home():
    return render_template_string(TEMPLATE_HOME)

@app.route('/kitchen')
def kitchen():
    init_db()
    conn = sqlite3.connect('izad_kitchen.db')
    conn.row_factory = sqlite3.Row
    items_raw = conn.execute('SELECT * FROM kitchen_items').fetchall()
    conn.close()
    
    processed_items = []
    today = datetime.now().date()
    
    for item in items_raw:
        item_dict = dict(item)
        status_color = "#2ed573" # Ø£Ø®Ø¶Ø± (Ø³Ù„ÙŠÙ…)
        expiry_msg = "Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©"
        
        # Ø°ÙƒØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙƒÙ…ÙŠØ©
        if item_dict['expiry_date']:
            expiry = datetime.strptime(item_dict['expiry_date'], '%Y-%m-%d').date()
            days_left = (expiry - today).days
            if days_left < 0:
                status_color = "#ff4757" # Ø£Ø­Ù…Ø± (Ù…Ù†ØªÙ‡ÙŠ)
                expiry_msg = "Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©!"
            elif days_left <= 3:
                status_color = "#ffa502" # Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ (Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹)
                expiry_msg = f"ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {days_left} Ø£ÙŠØ§Ù…"
        
        if item_dict['current_stock'] <= 0:
            status_color = "#eccc68" # Ø£ØµÙØ± (Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©)
            expiry_msg = "Ø§Ù„ÙƒÙ…ÙŠØ© Ù†Ø§ÙØ¯Ø©"

        item_dict['status_color'] = status_color
        item_dict['expiry_msg'] = expiry_msg
        processed_items.append(item_dict)
        
    return render_template_string(TEMPLATE_KITCHEN, items=processed_items)

# --- Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© (v2.20) ---

TEMPLATE_HOME = '''
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #FF6600 0%, #FF8C00 100%); min-height: 100vh; padding: 20px; color: #2C1A00; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 500px; margin: 40px auto; }
        .card { padding: 30px 10px; border-radius: 35px 15px; text-align: center; text-decoration: none; color: inherit; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: 0.3s; }
        .c-kitchen { background: linear-gradient(145deg, #FFF8E1, #FFECB3); }
        .c-meals { background: linear-gradient(145deg, #FFCDD2, #EF9A9A); }
        .c-lab { background: linear-gradient(145deg, #E1F5FE, #B3E5FC); }
        .c-benefits { background: linear-gradient(145deg, #E8F5E8, #C8E6C9); }
        .c-shopping { background: linear-gradient(145deg, #F3E5F5, #E1BEE7); }
        .c-settings { background: linear-gradient(145deg, #F5F5F5, #EEEEEE); }
    </style>
</head>
<body>
    <div style="text-align:center; color:white;"><h1>iZad V2.0</h1><p>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø±Ø§Ù…ÙŠ</p></div>
    <div class="grid-container">
        <a href="/kitchen" class="card c-kitchen">ğŸ¥˜ Ø§Ù„Ù…Ø·Ø¨Ø®</a>
        <a href="#" class="card c-meals">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</a>
        <a href="#" class="card c-lab">ğŸ“Š Ø§Ù„Ù…Ø¹Ù…Ù„</a>
        <a href="#" class="card c-benefits">ğŸ’° Ø§Ù„ÙÙˆØ§Ø¦Ø¯</a>
        <a href="#" class="card c-shopping">ğŸ›’ Ø§Ù„ØªØ³ÙˆÙ‚</a>
        <a href="#" class="card c-settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    </div>
</body>
</html>
'''

TEMPLATE_KITCHEN = '''
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(145deg, #FFF8E1, #FFECB3); min-height: 100vh; padding: 15px; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .item-card { 
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); 
            padding: 15px; border-radius: 20px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-right: 6px solid var(--sc);
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .modal-content { background: white; width: 85%; max-width: 400px; margin: 15% auto; padding: 25px; border-radius: 35px 10px; }
        .qty-ctrl { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .btn-round { width: 45px; height: 45px; border-radius: 50%; border: none; font-size: 1.5em; cursor: pointer; }
    </style>
</head>
<body>
    <div class="top-nav"><a href="/" style="text-decoration:none; font-size:1.5em;">ğŸ </a><h2>ğŸ¥˜ Ø§Ù„Ù…Ø·Ø¨Ø®</h2><button onclick="showM('addModal')" style="background:#FF6600; color:white; border:none; padding:10px 15px; border-radius:12px;">+ Ù…Ø§Ø¯Ø©</button></div>
    
    <div class="items-list">
        {% for item in items %}
        <div class="item-card" style="--sc: {{item.status_color}}" onclick="openD('{{item.id}}','{{item.name}}','{{item.current_stock}}','{{item.unit}}','{{item.purchase_source}}','{{item.expiry_date}}','{{item.expiry_msg}}','{{item.status_color}}')">
            <div><strong>{{ item.name }}</strong><br><small>{{ item.current_stock }} {{ item.unit }}</small></div>
            <div style="font-size:0.8em; color:{{item.status_color}};">{{ item.expiry_msg }}</div>
        </div>
        {% endfor %}
    </div>

    <div id="addModal" class="modal"><div class="modal-content">
        <h3>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø·Ø¨Ø®</h3>
        <form action="/add_item" method="POST">
            <select name="category" style="width:100%; padding:10px; margin:5px 0;"><option>Ø®Ø¶Ø±ÙˆØ§Øª</option><option>Ø£Ù„Ø¨Ø§Ù†</option><option>Ù…Ø¹Ù„Ø¨Ø§Øª</option></select>
            <input name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" style="width:100%; padding:10px; margin:5px 0;" required>
            <input name="current_stock" type="number" step="0.1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" style="width:100%; padding:10px; margin:5px 0;" required>
            <select name="unit" style="width:100%; padding:10px; margin:5px 0;"><option>ÙƒÙŠÙ„Ùˆ</option><option>Ù„ØªØ±</option><option>Ø­Ø¨Ø©</option></select>
            <input name="purchase_source" placeholder="Ù…ØµØ¯Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" style="width:100%; padding:10px; margin:5px 0;">
            <input name="expiry_date" type="date" style="width:100%; padding:10px; margin:5px 0;" required>
            <button type="submit" style="width:100%; background:#FF6600; color:white; padding:12px; border-radius:10px; border:none; margin-top:10px;">Ø­ÙØ¸ ğŸ“¥</button>
        </form>
    </div></div>

    <div id="infoModal" class="modal"><div class="modal-content" id="mContent" style="border-top:10px solid #FF6600;">
        <h2 id="dName" style="text-align:center;"></h2>
        <div class="qty-ctrl">
            <button class="btn-round" onclick="chQty(-1)">-</button>
            <span id="dStock" style="font-size:1.5em; font-weight:bold;"></span>
            <button class="btn-round" onclick="chQty(1)" style="background:#4ECDC4; color:white;">+</button>
        </div>
        <p>ğŸ“‚ Ø§Ù„ØªØµÙ†ÙŠÙ: <b id="dCat"></b></p>
        <p>ğŸ›’ Ø§Ù„Ù…ØµØ¯Ø±: <b id="dSource"></b></p>
        <p>ğŸ“… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: <b id="dExpiry"></b></p>
        <hr><br>
        <button onclick="delI()" style="width:100%; background:#ff4757; color:white; padding:10px; border:none; border-radius:10px;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©</button>
        <button onclick="hideM('infoModal')" style="width:100%; background:#2C1A00; color:white; padding:10px; border:none; border-radius:10px; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <script>
        let curId = null;
        function showM(id) { document.getElementById(id).style.display = 'block'; }
        function hideM(id) { document.getElementById(id).style.display = 'none'; }
        function openD(id, n, s, u, src, exp, msg, col) {
            curId = id;
            document.getElementById('dName').innerText = n;
            document.getElementById('dStock').innerText = s + ' ' + u;
            document.getElementById('dSource').innerText = src || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('dExpiry').innerText = exp || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
            document.getElementById('mContent').style.borderTopColor = col;
            showM('infoModal');
        }
        function chQty(val) { window.location.href = '/update_qty/' + curId + '/' + val; }
        function delI() { if(confirm("Ø­Ø°ÙØŸ")) window.location.href = '/delete_item/' + curId; }
    </script>
</body>
</html>
'''

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
